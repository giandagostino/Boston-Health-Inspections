---
title: "Geospatial Analysis"
output: html_document
date: "2025-12-06"
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(lubridate)
library(viridis)

# Load the single, final clean file
inspections <- read_csv("data/inspections_clean.csv")
```

### Boston Zipcodes Map

```{r}


bos_insp <- inspections |>
  filter(city_source == "Boston")
bos <- st_read("data/Boston Shapefiles/ZIP_Codes.shp")

bos_borders <- bos |> st_union() |>
  st_buffer(.5)
ggplot(bos_borders) +
  geom_sf(data=bos, aes(fill = ZIP5))


# Density map of restaurants per zipcode

rstnt_density <- bos_insp |>
  group_by(zip_code) |>
  summarize(n_restaurants = n_distinct(restaurant_name))

bos <- bos |>
  rename(zip_code = ZIP5)

bos_joined <- left_join(bos, rstnt_density, by = "zip_code")

ggplot(bos_borders) +
  geom_sf(data=bos_joined, aes(fill = n_restaurants))

```

## Analysis

I would like to investigate the geographic distribution of different
aspects of the health code inspections in Boston. To do this, I will
isolate all of the Boston health inspection records and map several
factors of the data onto a map of the City of Boston, separated by
zipcode subsection.

We have a restaurant density map already from EDA, but I want to be more
specific and see what the restaurant hotspots are in the city.

```{r hotspot}

# Group by all of the different restaurants, using addresses due to the fact that the same restaurant may be spelled slightly differently by different inspectors.

bos_insp <- inspections |>
  filter(city_source == "Boston")
bos <- st_read("data/Boston Shapefiles/ZIP_Codes.shp")

bos_borders <- bos |> st_union() |>
  st_buffer(.5)

###### ^^^^ Upload Shapefiles (same as EDA) ######


# Condense relevant data and reformat latitude and longitude. Airport restaurant coordinates seem to have been recorded wrong (showing up in atlantic ocean). Filter them out.


ind_rsts <- bos_insp |>
  distinct(address_full, .keep_all = TRUE) |>
  mutate(coords_clean = str_remove_all(location_string, "[()]"))|>
  separate(coords_clean, into = c("lat", "lon"), sep = ",", convert = T) |>
  mutate (
    lat = as.numeric(lat),
    lon = as.numeric(lon)
  ) |>
  drop_na(lat,lon) |>
  filter(
    lat > 41, lat < 42.8,
    lon > -71.8, lon < -70.7
  ) |>
  select(restaurant_name, address_full, lat, lon)


coords_sf <- ind_rsts |>
  st_as_sf(coords = c("lon", "lat"), crs = 4326) |>
  st_transform(26986)


bos <- bos |> 
  st_transform(26986)

df_coords <- as.data.frame(st_coordinates(coords_sf))

ggplot() +
  geom_density_2d_filled(
    data = df_coords,
    aes(X, Y, fill = ..level..),
    contour_var = "ndensity",
    alpha = 0.8,
    h = c(500, 500),
    clip = "on"
  ) +
  scale_fill_viridis_d(option = "mako", direction = -1, labels = NULL) +   
  theme_minimal() +
  labs(title = "City of Boston Restaurant Density",
       fill = "Density Scale\n(Least Dense to Most Dense)") +
  geom_sf(data = bos, fill = NA, color = "black", size = 0.05) +
  theme(panel.background = element_rect(fill = "#DEF5E5FF"),
        axis.text = element_blank(),
        theme(axis.title = element_blank()))

```

As we can see, there are hotspots near Harvard Ave in Allston, the North
End, Downtown Crossing, Chinatown, and Newbury St.

Seeing this distribution, I'm wondering if there are differences between
health code inspections for restaurants that are heavily clustered vs.
restaurants that are lightly distributed in their area. We will call the
former "Suburban" restaurants and the latter "Urban" restaurants.

**Suburban vs. Urban restaurants**

To make this comparison, we will have to establish rules for what
categorizes a restaurant as rural or urban. This will include all
restaurants that were opened For this investigation, these will be the
categories:

[Urban:]{.underline} Has more than or equal to **10** other restaurants
within a **100 meter** radius.

[Suburban:]{.underline} Has less than **10** other restaurants within a
**100 meter** radius.

```{r urban}

# Create circles around each rst

buffer <- st_buffer(coords_sf$geometry, dist = 100)

int <- st_intersects(buffer, coords_sf |> select(geometry))

# Count how many row joins per buffer

n_int <- lengths(int)

# I want the index of all of the restaurants that have more than x amount of restaurants in this radius

ind_rsts <- ind_rsts |>
  mutate(
    n_neighbor = n_int - 1,
    urban_yn = (n_int - 1) >= 10
  )

ind_rsts <- st_as_sf(ind_rsts, coords = c("lon", "lat"), crs = 4326)


# Now lets plot all of the restaurants with their new designations

ggplot() +
  geom_sf(data = ind_rsts,
          aes(color = urban_yn),
          size = 1,
          alpha = 0.2) +
  geom_sf(data = bos, fill = NA, color = "black") +
  labs(
    title = "All Restaurants Colored By Urban Designation",
    color = ""
  ) +
  scale_color_discrete(
    labels = c("TRUE" = "Urban", "FALSE" = "Suburban")
  )



```

**Hypothesis Tests**

Now that we've designated each restaurant as Urban or Rural, we can run
some hypothesis tests.

Do urban or suburban restaurants have more failed health inspections? Is
this difference significant?

```{r chisq}

#Expand individual restaurants and their urban/suburban designation to the full inspection report

new_bos_insp <- bos_insp |>
  left_join(
    ind_rsts |>
      st_drop_geometry() |>
      select(address_full, urban_yn, n_neighbor),
    by = "address_full"
  ) |>
  filter(
    !if_any(c(urban_yn,viol_status), ~is.na(.))
  )


library("janitor")

new_bos_insp |>
  tabyl(urban_yn, viol_status) |>
  adorn_totals("row") |>
  adorn_percentages("row") |>
  adorn_pct_formatting(digits = 1)


chisq.test(table(new_bos_insp$viol_status, new_bos_insp$urban_yn))


```

This proportion table with marginal proportions shows us that Pass Rate
for Urban restaurants is 0.8% higher than for Suburban restaurants. This
means that suburban restaurants tend to fail health inspections more
often than urban restaurants.

To see whether this result is significant, we can conduct a Chi-Squared
Test for independence. These are the assumptions:

-   Both Urban/Suburban status and Pass/Fail reports must be categorical
    variables with 2+ distinct groups

-   Categories within each designation must be mutually exclusive.

-   Each health inspection report must be independent of the others.

-   There must be more than 5 reports in each of the 4 categories.

With a p-value of 6.969x10\^-10, we can reject the null hypothesis that
the categories are independent from each another. [We have evidence that
Urban/Suburban designation and health inspection pass rates are
dependent on one another.]{.underline}

Now we want to know the specific relationship between Urban/Suburban
designation and Pass/Fail rates, if any.

```{r logit}

# Lets start by deconstructing the pass/fail rate into number of neighbor restaurants within a 100 meter radius, plotting the distribution

ggplot() +
  geom_histogram(data = ind_rsts, aes(x=n_neighbor), bins=39) +
  labs(title = "Histogram of Neighbor Restaurants Within a 100 Meter Radius",
       x = "Number of Neighbors",
       y = "Frequency")

# This distribiution is unimodal and smooth. Let's see if we can fit a logistic regression to this.

new_bos_insp <- new_bos_insp |>
  mutate(
    viol_status = viol_status == "Fail",
    viol_status_num = as.numeric(viol_status)
  )

model <- glm(viol_status_num ~ n_neighbor, data = new_bos_insp, family = binomial)



```
